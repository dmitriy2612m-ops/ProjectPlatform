name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ручной запуск

env:
  REGISTRY: docker.io
  IMAGE_PREFIX: autopark

jobs:
  tests:
    name: Matrix tests
    runs-on: self-hosted  # Используем локальный runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check Docker availability
      shell: cmd
      run: |
        docker --version
        if %errorlevel% neq 0 (
          echo ERROR: Docker CLI is not available. Please install Docker Desktop.
          exit 1
        )
        docker info >nul 2>&1
        if %errorlevel% neq 0 (
          echo WARNING: Docker daemon is not running. Attempting to start Docker Desktop...
          echo Please ensure Docker Desktop is running before running this workflow.
          echo You can start Docker Desktop manually or configure it to start automatically.
          exit 1
        )
        echo Docker is available and running
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      continue-on-error: true
    
    - name: Check Docker Compose version
      shell: cmd
      run: |
        docker compose version 2>nul || docker-compose --version 2>nul || echo Docker Compose not found
    
    - name: Clean up previous test containers
      shell: cmd
      run: |
        docker compose -f docker-compose.test.yml down -v 2>nul
        docker-compose -f docker-compose.test.yml down -v 2>nul
        echo Cleanup completed
    
    - name: Run tests
      shell: cmd
      run: |
        docker compose version >nul 2>&1
        if %errorlevel% equ 0 (
          docker compose -f docker-compose.test.yml up --abort-on-container-exit --exit-code-from test-runner
        ) else (
          docker-compose -f docker-compose.test.yml up --abort-on-container-exit --exit-code-from test-runner
        )
    
    - name: Show test logs on failure
      if: failure()
      shell: cmd
      run: |
        docker compose -f docker-compose.test.yml logs 2>nul || docker-compose -f docker-compose.test.yml logs 2>nul || echo Could not retrieve logs
        exit 0
    
    - name: Clean up test containers
      if: always()
      shell: cmd
      run: |
        docker compose -f docker-compose.test.yml down -v 2>nul
        if %errorlevel% neq 0 (
          docker-compose -f docker-compose.test.yml down -v 2>nul
        )
        echo Final cleanup completed
        exit 0

  build-and-push:
    name: build-and-push
    needs: tests
    runs-on: self-hosted  # Используем локальный runner
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Check Docker availability
      shell: cmd
      run: |
        docker --version
        if %errorlevel% neq 0 (
          echo ERROR: Docker CLI is not available. Please install Docker Desktop.
          exit 1
        )
        docker info >nul 2>&1
        if %errorlevel% neq 0 (
          echo WARNING: Docker daemon is not running. Attempting to start Docker Desktop...
          echo Please ensure Docker Desktop is running before running this workflow.
          echo You can start Docker Desktop manually or configure it to start automatically.
          exit 1
        )
        echo Docker is available and running
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
      continue-on-error: true
    
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build API image
      shell: cmd
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-api:latest ./src/api
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-api:${{ github.sha }} ./src/api
    
    - name: Build Dashboard image
      shell: cmd
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-dashboard:latest ./src/dashboard
        docker build -t ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-dashboard:${{ github.sha }} ./src/dashboard
    
    - name: Push images
      shell: cmd
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-api:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-api:${{ github.sha }}
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-dashboard:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.IMAGE_PREFIX }}-dashboard:${{ github.sha }}

  deploy:
    name: deploy
    needs: build-and-push
    runs-on: self-hosted  # Используем локальный runner
    if: (github.ref == 'refs/heads/main' && github.event_name == 'push') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Deploy to Docker Swarm
      shell: cmd
      run: |
        echo Deployment would happen here
        echo docker stack deploy -c docker-stack.yml autopark
